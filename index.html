<!DOCTYPE html>
<html>
<head>
    <title>Leaflet POI 示例</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        html, body {
            height: 100%; /* 设置html和body的高度为100% */
            margin: 0;
            padding: 0;
        }
        #map {
            height: 30vh; /* 设置地图高度为视口高度的30% */
        }
        #info {
            display: flex;
            justify-content: space-between;
            margin: 10px;
        }
        #address-box, #copy-box {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #copy-button {
            font-weight: bold; /* 加粗按钮文本 */
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="info">
        <div id="address-box">
            <span id="address">地址将显示在这里</span>
        </div>
        <div id="copy-box">
            <button id="copy-button">复制</button>
        </div>
    </div>
    <p>授权定位将协助您的信息填写</p>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var defaultLat = 41.891767; // 罗马的纬度
        var defaultLng = 12.482325; // 罗马的经度

        // 初始化地图，设置默认视图为罗马
        var map = L.map('map', {
            zoomControl: false // 禁用默认的缩放控件
        }).setView([defaultLat, defaultLng], 13);

        // 添加OpenStreetMap图层
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // 手动添加缩放控件到左下角
        L.control.zoom({
            position: 'bottomleft' // 你可以选择 'topleft', 'topright', 'bottomleft', 'bottomright'
        }).addTo(map);

        // 尝试定位用户位置
        map.locate({
            setView: true,
            maxZoom: 16
        });

        // 当定位成功时的处理函数
        map.on('locationfound', function(e) {
            var userPosition = e.latlng;
            var radius = e.accuracy / 2;

            // 使用Nominatim进行逆地理编码
            var url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + userPosition.lat + ',' + userPosition.lng + '&polygon=1&addressdetails=1';
            fetch(url)
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    var bounds = new L.LatLngBounds();
                    data.forEach(function(poi) {
                        var poiLatLng = new L.LatLng(poi.lat, poi.lon);
                        var marker = L.marker(poiLatLng).addTo(map);
                        var popupContent = poi.display_name;
                        marker.bindPopup(popupContent).openPopup(); // 默认打开弹出窗口
                        bounds.extend(poiLatLng);
                    });
                    map.fitBounds(bounds, {padding: [50, 50]});
                    // 更新地址信息
                    document.getElementById('address').textContent = data[0].display_name;
                });
        });

        // 当定位失败时的处理函数
        map.on('locationerror', function(e) {
            console.log('定位错误: ', e.message);
            // 设置默认地址信息
            document.getElementById('address').textContent = '罗马, 意大利';
        });

        // 复制按钮功能
        document.getElementById('copy-button').addEventListener('click', function() {
            var address = document.getElementById('address').textContent;
            navigator.clipboard.writeText(address).then(function() {
                alert('地址已复制到剪贴板!');
            }, function(err) {
                console.error('无法复制文本: ', err);
            });
        });
    </script>
</body>
</html>
